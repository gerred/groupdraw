function Arrow(a,b,c){this.startX=a,this.startY=b,this.endX=a,this.endY=b,this.uuid=c}function Screenshot(a,b,c,d,e){this.ready=!1,this.image=new Image,this.image.src=a,this.image.onload=function(){this.ready=!0,typeof e=="function"&&e.call(this)}.bind(this),this.outWidth=b,this.outHeight=c,this.uuid=d}(function(){function n(a,b,c){var d=b&&c||0,e=0;b=b||[],a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){e<16&&(b[d+e++]=l[a])});while(e<16)b[d+e++]=0;return b}function o(a,b){var c=b||0,d=k;return d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]}function u(a,b,c){var d=b&&c||0,e=b||[];a=a||{};var f=a.clockseq!=null?a.clockseq:r,g=a.msecs!=null?a.msecs:(new Date).getTime(),h=a.nsecs!=null?a.nsecs:t+1,i=g-s+(h-t)/1e4;i<0&&a.clockseq==null&&(f=f+1&16383),(i<0||g>s)&&a.nsecs==null&&(h=0);if(h>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");s=g,t=h,r=f,g+=122192928e5;var j=((g&268435455)*1e4+h)%4294967296;e[d++]=j>>>24&255,e[d++]=j>>>16&255,e[d++]=j>>>8&255,e[d++]=j&255;var k=g/4294967296*1e4&268435455;e[d++]=k>>>8&255,e[d++]=k&255,e[d++]=k>>>24&15|16,e[d++]=k>>>16&255,e[d++]=f>>>8|128,e[d++]=f&255;var l=a.node||q;for(var m=0;m<6;m++)e[d+m]=l[m];return b?b:o(e)}function v(a,b,c){var d=b&&c||0;typeof a=="string"&&(b=a=="binary"?new j(16):null,a=null),a=a||{};var e=a.random||(a.rng||i)();e[6]=e[6]&15|64,e[8]=e[8]&63|128;if(b)for(var f=0;f<16;f++)b[d+f]=e[f];return b||o(e)}var a=this,b,c,d,e=new Array(16);b=function(){var a,b=e,c=0;for(var c=0,a;c<16;c++)(c&3)==0&&(a=Math.random()*4294967296),b[c]=a>>>((c&3)<<3)&255;return b};if(a.crypto&&crypto.getRandomValues){var f=new Uint32Array(4);d=function(){crypto.getRandomValues(f);for(var a=0;a<16;a++)e[a]=f[a>>2]>>>(a&3)*8&255;return e}}try{var g=require("crypto").randomBytes;c=g&&function(){return g(16)}}catch(h){}var i=c||d||b,j=typeof Buffer=="function"?Buffer:Array,k=[],l={};for(var m=0;m<256;m++)k[m]=(m+256).toString(16).substr(1),l[k[m]]=m;var p=i(),q=[p[0]|1,p[1],p[2],p[3],p[4],p[5]],r=(p[6]<<8|p[7])&16383,s=0,t=0,w=v;w.v1=u,w.v4=v,w.parse=n,w.unparse=o,w.BufferClass=j,w.mathRNG=b,w.nodeRNG=c,w.whatwgRNG=d;if(typeof module!="undefined")module.exports=w;else{var x=a.uuid;w.noConflict=function(){return a.uuid=x,w},a.uuid=w}})();var util={};util.getMousePos=function a(a,b){var c=a,d=0,e=0;while(c&&c.tagName!="BODY")d+=c.offsetTop,e+=c.offsetLeft,c=c.offsetParent;var f=b.clientX-e+window.pageXOffset,g=b.clientY-d+window.pageYOffset;return{x:f,y:g}},jQuery(function(a){function h(a){mouse=util.getMousePos(b,a),g.setEnd(mouse.x,mouse.y),d.emit("draw",g),c.clearRect(0,0,b.width,b.height);for(var e in f)f[e].draw(c)}var b=document.getElementById("canvas"),c=b.getContext("2d"),d=io.connect(),e="#000000",f={},g;d.on("imageload",function(b){f={},screenshot=new Screenshot(b.url,b.width,b.height,b.uuid,function(){a("#canvas").attr("width",b.width),a("#canvas").attr("height",b.height),this.draw(c)}),f[screenshot.uuid]=screenshot}),d.on("draw",function(a){f.hasOwnProperty(a.uuid)?(d=f[a.uuid],d.endX=a.endX,d.endY=a.endY):f[a.uuid]=new Arrow(a.startX,a.startY,a.uuid),c.clearRect(0,0,b.width,b.height);for(var d in f)f[d].draw(c)}),d.on("clear",function(){f={},c.clearRect(0,0,b.width,b.height)}),b.addEventListener("mousedown",function(a){var c=util.getMousePos(b,a);g=new Arrow(c.x,c.y,uuid.v4()),f[g.uuid]=g,d.emit("draw",g),b.addEventListener("mousemove",h,!1)},!1),b.addEventListener("mouseup",function(){b.removeEventListener("mousemove",h,!1)},!1),a(".block").on("click",function(b){e=a(this).data("color")}),a("form").on("submit",function(b){b.preventDefault(),image=new Image,image.src=a("#name").val(),image.onload=function(){a("#canvas").attr("width",image.width),a("#canvas").attr("height",image.height),f={},screenshot=new Screenshot(image.src,image.width,image.height,uuid.v4(),function(){this.draw(c),d.emit("imageload",{url:image.src,width:image.width,height:image.height,uuid:image.uuid})}),f[screenshot.uuid]=screenshot}}),a(".mydownload").on("click",function(a){a.preventDefault();var c=b.toDataURL("image/png;base64");c=c.replace("image/png","image/octet-stream"),document.location.href=c}),a(".clear").on("click",function(a){d.emit("clear"),f={},c.clearRect(0,0,b.width,b.height)})}),Arrow.prototype.setEnd=function(a,b){this.endX=a,this.endY=b},Arrow.prototype.draw=function(a){var b=Math.atan2(this.endY-this.startY,this.endX-this.startX),c=10;a.save(),a.beginPath(),a.moveTo(this.startX,this.startY),a.lineTo(this.endX,this.endY),a.lineTo(this.endX-c*Math.cos(b-Math.PI/6),this.endY-c*Math.sin(b-Math.PI/6)),a.moveTo(this.endX,this.endY),a.lineTo(this.endX-c*Math.cos(b+Math.PI/6),this.endY-c*Math.sin(b+Math.PI/6)),a.stroke(),a.closePath(),a.restore()},Screenshot.prototype.draw=function(a){this.ready&&(a.save(),a.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,this.outWidth,this.outHeight),a.restore())}